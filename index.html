<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Prompt Avatar</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat ikon (Lucide) - DIPERBAIKI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Latar belakang abu-abu sangat muda */
        }
        
        /* Style untuk tombol radio kustom */
        .has-[:checked]:bg-blue-50 {
            background-color: #eff6ff;
        }
        .has-[:checked]:border-blue-500 {
            border-color: #3b82f6;
        }

        /* Style untuk spinner/loading */
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Kolom Kiri: Input Pengguna -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
            <h1 class="text-3xl font-bold text-slate-800 mb-6">Generator Prompt Avatar</h1>

            <!-- 1. Pengaturan API Key -->
            <div class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h2 class="text-lg font-semibold text-slate-700 mb-3">Pengaturan API Key</h2>
                <div class="space-y-3">
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-2">Google AI Studio API Key</label>
                    <div id="api-key-form" class="flex items-center space-x-2">
                        <input type="password" id="api-key-input" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Masukkan API Key Anda...">
                        <button id="save-key-button" class="w-32 flex items-center justify-center bg-blue-600 text-white px-4 py-3 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all font-medium text-sm">
                            <span class="spinner" id="save-spinner" style="display: none;"></span>
                            <span id="save-button-text">Simpan</span>
                        </button>
                    </div>
                    <!-- PESAN ERROR KHUSUS UNTUK API KEY -->
                    <div id="api-key-error" class="hidden text-red-600 text-sm mt-2"></div>
                    
                    <div id="api-key-display" class="hidden items-center justify-between">
                        <p id="api-key-status" class="text-sm text-green-600 font-medium">API Key tersimpan.</p>
                        <button id="delete-key-button" class="text-xs text-red-500 hover:text-red-700 hover:underline">Hapus Key</button>
                    </div>
                </div>
            </div>

            <!-- 2. Detail Produk Anda -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Unggah Gambar Produk</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-lg">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            <div class="flex text-sm text-slate-600">
                                <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                    <span>Unggah file</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/png, image/jpeg, image/webp">
                                </label>
                                <p class="pl-1">atau seret dan lepas</p>
                            </div>
                            <p class="text-xs text-slate-500" id="file-name">PNG, JPG, WEBP hingga 10MB</p>
                        </div>
                    </div>
                    <!-- Image preview -->
                    <div id="image-preview-container" class="hidden mt-4 text-center">
                        <img id="image-preview" src="#" alt="Pratinjau Gambar Produk" class="max-h-40 mx-auto rounded-lg shadow-md">
                        <button id="remove-image" class="mt-2 text-xs text-red-500 hover:underline">Hapus Gambar</button>
                    </div>
                </div>

                <div>
                    <label for="product-description" class="block text-sm font-medium text-gray-700 mb-2">2. Deskripsi Produk</label>
                    <textarea id="product-description" rows="4" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Contoh: Produk serum pencerah baru, bahan alami, menargetkan wanita usia 30-50 tahun."></textarea>
                </div>

                <!-- 3. Mode Pembuatan Prompt -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">3. Mode Pembuatan Prompt</label>
                    <div id="prompt-mode" class="flex flex-col sm:flex-row gap-4">
                        <!-- Opsi 1: Avatar Review -->
                        <label class="flex-1 flex items-center p-3 border border-slate-300 rounded-lg shadow-sm cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                            <input type="radio" name="promptMode" value="review" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                            <div class="ml-3 text-sm">
                                <span class="font-medium text-slate-800">Avatar Review</span>
                                <p class="text-xs text-slate-500">Fokus wajah/produk, tanpa latar.</p>
                            </div>
                        </label>
                        <!-- Opsi 2: Model Profesional -->
                        <label class="flex-1 flex items-center p-3 border border-slate-300 rounded-lg shadow-sm cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                            <input type="radio" name="promptMode" value="pro" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <div class="ml-3 text-sm">
                                <span class="font-medium text-slate-800">Model Profesional</span>
                                <p class="text-xs text-slate-500">Scene lengkap, latar, & efek.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Tombol Buat Prompt -->
                <button id="generate-button" class="w-full flex items-center justify-center bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all font-semibold text-base">
                    <span class="spinner" id="generate-spinner" style="display: none; margin-right: 8px;"></span>
                    <span id="generate-button-text">Buat 5 Opsi Prompt</span>
                </button>

                <!-- Global Error Message -->
                <div id="error-message" class="hidden bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded-lg text-sm"></div>

            </div>
        </div>

        <!-- Kolom Kanan: Output AI -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Hasil Prompt</h2>
            <div id="output-container" class="space-y-4 h-[70vh] overflow-y-auto pr-2">
                <!-- Placeholder saat kosong -->
                <div id="placeholder" class="text-center text-slate-400 pt-16">
                    <svg class="mx-auto h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m1.636-6.364l.707.707M12 21v-1m-6.364-1.636l.707-.707M6 12H5m1.636 6.364l.707-.707"></path></svg>
                    <p class="mt-4 text-lg font-medium">Hasil prompt Anda akan muncul di sini.</p>
                    <p class="text-sm">Isi detail produk dan klik "Buat Prompt" untuk memulai.</p>
                </div>

                <!-- Hasil prompt akan dimasukkan di sini oleh JS -->
                
            </div>
        </div>

    </div>

    <script type="module">
        // Kunci untuk localStorage
        const API_KEY_STORAGE_KEY = 'gemini_api_key_avatar_app';

        // --- Variabel Global untuk UI ---
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyButton = document.getElementById('save-key-button');
        const deleteKeyButton = document.getElementById('delete-key-button');
        const apiKeyForm = document.getElementById('api-key-form');
        const apiKeyDisplay = document.getElementById('api-key-display');
        const apiKeyStatus = document.getElementById('api-key-status');
        const apiKeyErrorMessage = document.getElementById('api-key-error');
        const saveSpinner = document.getElementById('save-spinner');
        const saveButtonText = document.getElementById('save-button-text');

        const fileUpload = document.getElementById('file-upload');
        const fileName = document.getElementById('file-name');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image');
        const productDescription = document.getElementById('product-description');
        const generateButton = document.getElementById('generate-button');
        const generateSpinner = document.getElementById('generate-spinner');
        const generateButtonText = document.getElementById('generate-button-text');
        
        const outputContainer = document.getElementById('output-container');
        const placeholder = document.getElementById('placeholder');
        const globalErrorMessage = document.getElementById('error-message');

        // Variabel untuk menyimpan data gambar
        let base64ImageData = null;
        let imageMimeType = null;

        // --- Inisialisasi Aplikasi ---
        window.onload = () => {
            updateKeyUI();
            lucide.createIcons(); // Inisialisasi ikon
        };

        // --- 1. Logika API Key ---

        /** Memperbarui UI API Key berdasarkan localStorage */
        function updateKeyUI() {
            const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (storedKey) {
                apiKeyForm.classList.add('hidden');
                apiKeyDisplay.classList.add('flex'); // Tampilkan status 'tersimpan'
                apiKeyStatus.innerText = `API Key tersimpan.`;
                apiKeyErrorMessage.classList.add('hidden');
            } else {
                apiKeyForm.classList.remove('hidden');
                apiKeyDisplay.classList.add('hidden');
                apiKeyInput.value = ''; // Kosongkan input
            }
        }

        /** Menyimpan dan Memvalidasi API Key */
        async function saveKey() {
            const key = apiKeyInput.value.trim();

            if (!key) {
                apiKeyErrorMessage.innerText = "Silakan masukkan API Key yang valid.";
                apiKeyErrorMessage.classList.remove('hidden');
                setTimeout(() => {
                    if (apiKeyErrorMessage.innerText === "Silakan masukkan API Key yang valid.") {
                        apiKeyErrorMessage.classList.add('hidden');
                    }
                }, 3000);
                return;
            }

            // Tampilkan status validasi di tombol
            saveKeyButton.disabled = true; // <-- DIPERBAIKI (sebelumnya saveButton)
            saveSpinner.style.display = 'inline-block';
            saveButtonText.innerText = 'Validasi...';
            apiKeyErrorMessage.classList.add('hidden');

            try {
                // Panggilan tes ringan untuk validasi key
                // Kita akan coba ambil detail model 'gemini-2.5-flash-preview-09-2025'
                // Ini tes yang lebih spesifik daripada hanya 'list models'
                const validationUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025?key=${key}`;
                const response = await fetch(validationUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.error?.message || 'API Key tidak valid atau tidak memiliki izin.';
                    
                    let displayError;
                    if (errorMsg.includes("API key not valid")) {
                        displayError = 'apikey tidak valid.'; // Pesan spesifik
                    } else {
                        displayError = errorMsg;
                    }
                    
                    apiKeyErrorMessage.innerText = displayError;
                    apiKeyErrorMessage.classList.remove('hidden');
                } else {
                    // Berhasil! Simpan key
                    localStorage.setItem(API_KEY_STORAGE_KEY, key);
                    updateKeyUI();
                    apiKeyErrorMessage.classList.add('hidden');
                }
            } catch (error) {
                // Error jaringan
                apiKeyErrorMessage.innerText = `Validasi gagal: ${error.message}. Periksa koneksi internet Anda.`;
                apiKeyErrorMessage.classList.remove('hidden');
            } finally {
                // Setel ulang tombol
                saveKeyButton.disabled = false; // <-- DIPERBAIKI (sebelumnya saveButton)
                saveSpinner.style.display = 'none';
                saveButtonText.innerText = 'Simpan';
            }
        }

        /** Menghapus API Key */
        function deleteKey() {
            if (confirm('Anda yakin ingin menghapus API Key yang tersimpan?')) {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
                updateKeyUI();
            }
        }

        // --- 2. Logika Unggah Gambar ---

        /** Menangani perubahan file input */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showGlobalError("Ukuran file terlalu besar. Maksimal 10MB.");
                    return;
                }
                
                if (!['image/png', 'image/jpeg', 'image/webp'].includes(file.type)) {
                    showGlobalError("Format file tidak didukung. Gunakan PNG, JPG, atau WEBP.");
                    return;
                }

                imageMimeType = file.type;
                fileName.innerText = file.name;
                
                // Tampilkan pratinjau
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    
                    // Simpan data base64 (setelah 'base64,')
                    base64ImageData = e.target.result.split(',')[1];
                };
                reader.readAsDataURL(file);
            }
        }

        /** Menghapus gambar yang dipilih */
        function removeImage() {
            fileUpload.value = ''; // Reset input file
            fileName.innerText = 'PNG, JPG, WEBP hingga 10MB';
            imagePreviewContainer.classList.add('hidden');
            imagePreview.src = '#';
            base64ImageData = null;
            imageMimeType = null;
        }

        // --- 3. Logika Pembuatan Prompt (AI) ---

        // OTAK AI 1: Untuk Avatar Review
        const systemPrompt_Review = {
            parts: [{ text: `You are an expert casting model for product review videos in Southeast Asia.
Your task is to create 5 DIFFERENT image prompt options for a review video avatar.
Avatars MUST be from specific Southeast Asian nationalities (Indonesian, Thai, Vietnamese, Malaysian, Filipino). DO NOT use the term "Southeast Asian".
The prompt MUST focus ONLY on the avatar's appearance (face, hair, expression) and their uniform/clothing (must be relevant to the product).
Expression must be friendly, honest, and convincing, as if giving a testimonial.
DO NOT describe background, pose, lighting, or cinematic style.
Output MUST be in English.
DO NOT use markdown. Return the 5 options in a JSON string array.
Example: ["A 30s Indonesian woman...", "A smiling Thai man..."]`}]
        };

        // OTAK AI 2: Untuk Model Profesional
        const systemPrompt_Pro = {
            parts: [{ text: `You are a Creative Director for a high-end brand photoshoot.
Your task is to create 5 DIFFERENT image prompt options for a professional ad scene.
Avatars MUST be from specific Southeast Asian nationalities (Indonesian, Thai, Vietnamese, Malaysian, Filipino). DO NOT use the term "Southeast Asian".

CRITICAL RULE: The model should NOT be shown using, holding, applying, or interacting with the product. The model should pose professionally to represent the brand's image and atmosphere.

The prompt MUST describe the COMPLETE SCENE in English:
1.  **Avatar:** Specific actor/model (age, gender, nationality), looking confident and professional.
2.  **Clothing:** Professional or stylish uniform/outfit (not interacting with the product).
3.  **Background:** A supportive, high-quality interior or exterior (office, nature, luxury cafe).
4.  **Lighting & Effects:** (e.g., "Golden hour", "Bright studio lighting", "Bokeh effect").
The style must be cinematic, elegant, and professional.
Output MUST be in English.
DO NOT use markdown. Return the 5 options in a JSON string array.
Example: ["A confident Indonesian male executive in a sharp suit, standing in a modern high-rise office overlooking the city, soft morning light.", "An elegant Vietnamese woman in a silk dress, posing in a beautiful botanical garden, soft bokeh background."]`}]
        };

        /** Fungsi utama untuk memanggil Gemini API */
        async function generatePrompt(retryCount = 0) {
            const apiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            const desc = productDescription.value.trim();
            const mode = document.querySelector('input[name="promptMode"]:checked').value;

            // Validasi input
            if (!apiKey) {
                showGlobalError("API Key Google AI Studio tidak ditemukan. Harap simpan API Key Anda di Pengaturan.");
                return;
            }
            if (!base64ImageData || !imageMimeType) {
                showGlobalError("Silakan unggah gambar produk terlebih dahulu.");
                return;
            }
            if (!desc) {
                showGlobalError("Silakan isi deskripsi produk terlebih dahulu.");
                return;
            }

            // Tampilkan status loading
            setLoading(true);

            // Pilih "Otak" AI berdasarkan mode
            const selectedSystemPrompt = (mode === 'pro') ? systemPrompt_Pro : systemPrompt_Review;

            // Buat payload
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: `Deskripsi Produk: ${desc}` },
                            {
                                inlineData: {
                                    mimeType: imageMimeType,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: selectedSystemPrompt,
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Handle API errors (termasuk throttling 429)
                    if (response.status === 429 && retryCount < 3) {
                        // Exponential backoff: 1s, 2s, 4s
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return generatePrompt(retryCount + 1); // Coba lagi
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Error: ${response.status}`);
                }

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const promptArray = JSON.parse(jsonText);
                    displayResults(promptArray);
                } else {
                    throw new Error("Respons AI tidak valid atau kosong.");
                }

            } catch (error) {
                showGlobalError(`Gagal membuat prompt: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // --- 4. Fungsi Utilitas UI ---

        /** Menampilkan hasil (array of prompts) di UI */
        function displayResults(prompts) {
            outputContainer.innerHTML = ''; // Kosongkan kontainer
            placeholder.classList.add('hidden');

            prompts.forEach((promptText, index) => {
                const promptId = `prompt-${index}`;
                const card = document.createElement('div');
                card.className = 'bg-slate-50 border border-slate-200 p-4 rounded-lg shadow-sm';
                
                card.innerHTML = `
                    <p id="${promptId}" class="text-sm text-slate-700 mb-3">${promptText}</p>
                    <button data-copy-target="${promptId}" class="copy-button flex items-center text-xs font-medium text-blue-600 hover:text-blue-800 transition-all">
                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 4h8a2 2 0 012 2v8a2 2 0 01-2 2h-8a2 2 0 01-2-2v-8a2 2 0 012-2z"></path></svg>
                        Salin Prompt
                    </button>
                `;
                outputContainer.appendChild(card);
            });
        }

        /** Menyalin teks ke clipboard */
        function copyPrompt(event) {
            // Kita cari tombol yang diklik
            const button = event.target.closest('.copy-button');
            if (!button) return;

            const targetId = button.dataset.copyTarget;
            const textToCopy = document.getElementById(targetId).innerText;
            
            try {
                // Metode fallback untuk clipboard
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                // Feedback visual
                const originalText = button.innerHTML;
                button.innerHTML = `
                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Tersalin!
                `;
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);

            } catch (err) {
                showGlobalError('Gagal menyalin prompt.');
            }
        }

        /** Menampilkan status loading di tombol utama */
        function setLoading(isLoading) {
            if (isLoading) {
                generateButton.disabled = true;
                generateSpinner.style.display = 'inline-block';
                generateButtonText.innerText = 'Membuat Prompt...';
                globalErrorMessage.classList.add('hidden'); // Sembunyikan error lama
            } else {
                generateButton.disabled = false;
                generateSpinner.style.display = 'none';
                generateButtonText.innerText = 'Buat 5 Opsi Prompt';
            }
        }

        /** Menampilkan pesan error global */
        function showGlobalError(message) {
            globalErrorMessage.innerText = message;
            globalErrorMessage.classList.remove('hidden');
            // Sembunyikan setelah 5 detik
            setTimeout(() => {
                globalErrorMessage.classList.add('hidden');
            }, 5000);
        }
        
        // --- Event Listeners ---
        saveKeyButton.addEventListener('click', saveKey);
        deleteKeyButton.addEventListener('click', deleteKey);
        fileUpload.addEventListener('change', handleFileSelect);
        removeImageButton.addEventListener('click', removeImage);
        generateButton.addEventListener('click', () => generatePrompt(0)); // Mulai generate (retry count 0)
        outputContainer.addEventListener('click', copyPrompt); // Event delegation untuk tombol salin

    </script>
</body>
</html>



